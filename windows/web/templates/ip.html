{% extends 'base.html' %}
{% load static %}

{% block title %}
    Список IP
{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static './css/ip.css' %}">k
{% endblock %}

{% block content %}
<div class="ip-list">
    <h2 class="page-header">Постоянные устройства:</h2>
    <ul id="trusted-ip">
        <li id="1-t">
            <div class="ip">
                <div class="ip-addr">127.0.0.1</div>
                <div class="name-for-ip"><i>Имя 1</i></div>
                <div class="date-added"><b>10.10.2010</b></div>

                <div class="remove-from-trusted"  onclick="remove(1)">
                    <div class="plus-hr first-hr"></div>
                    <div class="plus-hr second-hr"></div>
                </div>
            </div>
        </li>
    </ul>
</div>

<div class="ip-list">
    <h2 class="page-header">Новые устройства: </h2>

    <ul id="new-ip">

        <li id="3-ut">
            <div class="ip">
                <div class="ip-addr">192.168.1.1</div> 
                <div class="name-for-ip"><i>Имя 4</i></div>
                <div class="date-added"><b>10.10.2010</b></div>

                <div class="add-to-trusted"  onclick="add(3)">
                    <div class="plus-hr first-hr"></div>
                    <div class="plus-hr second-hr"></div>
                </div>
        </li>
        
    </ul>
</div>
<div class="templates" style="display: none;">
    <div class="untrusted">
        <li id="1-t">
            <div class="ip">
                <div class="ip-addr"></div>
                <div class="name-for-ip"><i></i></div>
                <div class="date-added"><b></b></div>

                <div class="remove-from-trusted"  onclick="remove(1)">
                    <div class="plus-hr first-hr"></div>
                    <div class="plus-hr second-hr"></div>
                </div>
            </div>
        </li>
    </div>
    <div class="trusted">
        <li id="3-ut">
            <div class="ip">
                <div class="ip-addr"></div> 
                <div class="name-for-ip"><i></i></div>
                <div class="date-added"><b></b></div>

                <div class="add-to-trusted"  onclick="add(3)">
                    <div class="plus-hr first-hr"></div>
                    <div class="plus-hr second-hr"></div>
                </div>
        </li>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
        function add(id){
            let block = document.getElementById(`${id}-ut`);
            let newId = document.getElementById("trusted-ip").childElementCount + 1;
            block.id = `${newId}-t`;
            
            let plus = block.getElementsByClassName("add-to-trusted")[0];
            plus.removeAttribute("onclick")
            plus.setAttribute("oncilck", `remove(${newId})`)
            plus.classList.replace("add-to-trusted", "remove-from-trusted")

            document.getElementById("trusted-ip").appendChild(block);

            let data = {
                ip: block.getElementsByClassName("ip-addr")[0].innerHTML
            }
            var csrftoken = '{{ csrf_token }}';

            $.ajax({
                url: '{% url "ajax-resolve-ip" %}',
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFTOKEN': csrftoken
                },
                data: JSON.stringify(data),
                success: function (response) {
                    console.log(response);
                }
            });


        }
        function remove(id){
            let block = document.getElementById(`${id}-t`);
            let newId = document.getElementById("new-ip").childElementCount + 1;
            block.id = `${newId}-ut`;
            
            let plus = block.getElementsByClassName("remove-from-trusted")[0];
            plus.removeAttribute("onclick")
            plus.setAttribute("oncilck", `add(${newId})`)
            plus.classList.replace("remove-from-trusted", "add-to-trusted")

            document.getElementById("new-ip").appendChild(block);

            let data = {
                ip: block.getElementsByClassName("ip-addr")[0].innerHTML
            }
            
            var csrftoken = '{{ csrf_token }}';

            $.ajax({
                url: '{% url "ajax-unresolve-ip" %}',
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFTOKEN': csrftoken
                },
                data: JSON.stringify(data),
                success: function (response) {
                    console.log(response);
                }
            });

        }
    </script>
    <script>
        setInterval(()=>{
            $.ajax({
                url: '{% url "ajax-ip" %}',
                type: 'GET',
                dataType: 'json',
                success: function(response){
                    console.log(response)
                    response['old'].forEach(element => {
                        console.log(element)
                    });
                },
                error: function(xhr, status, error) {
                    console.log('.');
                }
            });
        }, 10000)
    </script>

{% endblock %}